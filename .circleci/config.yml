version: 2.1

jobs:
  start-docker:
    working_directory: ~/repo
    machine: 
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - run:
          name: Start docker
          command: docker-compose up -d
  build:
    working_directory: ~/repo
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Build
          command: mvn -B -DskipTests clean package
  test:
    working_directory: ~/repo
    docker:
      - image: cimg/openjdk:11.0
      - image: circleci/mysql:latest
    steps:
      - checkout
      - run:
          name: Test
          command: mvn test
  deploy-develop:
    docker:
      - image: cimg/openjdk:11.0

    steps:
      - checkout

  deploy-prod:
    docker:
      - image: cimg/openjdk:11.0

    steps:
      - checkout

workflows:
  version: 2
  build-and-deploy-on-hold:
    jobs:
      - start-docker
#       - build:
#           requires:
#             - start-docker
      - test
#           requires:
#             - build

#       - hold:
#           type: approval
#           requires:
#             - test
#           filters:
#             branches:
#               only: main
          

#       - deploy-develop:
#           requires:
#             - test
#             - build
#           filters:
#             branches:
#               only: develop

#       - deploy-prod:
#           requires:
#             - build
#             - test
#             - hold
#           filters:
#             branches:
#               only: main
